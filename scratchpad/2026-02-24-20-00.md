# Title: Fix input token counting discrepancy and add cache pricing settings

## Issue Summary
Dashboard showed ~300k input tokens while Anthropic's billing dashboard showed ~2.8M. Output tokens were roughly correct (~75k vs ~80k). Additionally, cache pricing multipliers were hardcoded with no UI to configure them.

## Root Cause
Anthropic's API returns three separate token fields:
- `input_tokens` — tokens NOT served from cache
- `cache_creation_input_tokens` — tokens written to cache (miss, billed at ~1.25x input)
- `cache_read_input_tokens` — tokens served from cache (hit, billed at ~0.1x input)

All dashboard SQL queries only summed `input_tokens`, missing the ~2.5M tokens that were cache reads and cache writes. Anthropic's billing dashboard counts all three as total input (billed at different rates).

## Old Behaviour
- "Input Tokens" sidebar stat and all aggregate queries only summed raw `input_tokens` (the uncached portion).
- Cache read/write tokens were displayed as a separate "Cache Tokens" card in the sidebar with `read from cache` and `written to cache` sub-labels.
- Conversations table showed only uncached input in the "Input" column and `{read}r/{write}w` in the "Cache" column.
- Conversation detail modal had separate "Cache Read" and "Cache Write" stats.
- Cache pricing multipliers (0.1 for read, 1.25/1.0 for write) were hardcoded in `calculateCost()` despite the database schema already having `cache_read_multiplier_*` and `cache_write_multiplier_*` settings.

## New Behaviour
- "Input Tokens" now shows the true total: `input_tokens + cache_creation_tokens + cache_read_tokens`, matching Anthropic's dashboard.
- A "from cache" sub-value under Input Tokens shows the cache hit portion (`cache_read_tokens`).
- The standalone "Cache Tokens" sidebar card was removed (cache hit info folded into Input stat).
- Conversations table "Input" column shows true total; "Cache" column renamed to "Cache Hit" and shows only `cache_read_tokens`.
- Conversation detail modal: "Cache Write" stat removed, "Cache Read" renamed to "Cache Hit".
- New "Cache Pricing" section in Settings modal with per-provider editable multipliers for cache hit and cache write rates.
- `calculateCost()` reads multipliers from the database via `getCacheMultipliersFromDB()` (with 60s cache) instead of using hardcoded values.

## Files Changed

### `src/database/database.js`
- **`getStatistics()`** (line 405): `SUM(input_tokens)` → `SUM(input_tokens + cache_creation_tokens)` for `total_input_tokens`.
- **`getRecentConversations()`** (line 669): Same change to `total_input_tokens`.
- **`getTokenUsageTimeSeries()`** (line 461): Same change for chart data `input_tokens`.
- **`getTokenUsageTimeSeriesByDomain()`** (line 816): Same change.
- **`getTokenUsageTimeSeriesByDomainGroup()`** (line 888): Same change.
- **`getUsageByModel()`** (line 489): Same change for `total_input_tokens`.
- **`getCacheStatistics()`** (line 1143): Intentionally left unchanged — needs raw `input_tokens` for per-provider cache ratio analysis.

### `src/dashboard/public/index.html`

#### HTML Changes
- **Sidebar stats** (line ~1154): Replaced "Cache Tokens" card (which had `#stat-cache-read`, `#stat-cache-write` sub-values) with a "from cache" sub-value (`#stat-cache-hit`) under the existing "Input Tokens" stat.
- **Conversations table header** (line ~1237): "Cache" → "Cache Hit".
- **Conversation detail modal** (line ~1272): Removed "Cache Write" `summary-stat` div entirely. Renamed "Cache Read" label to "Cache Hit".

#### JavaScript Changes
- **`loadStatistics()`** (line ~1798): Computes `totalInput = total_input_tokens + total_cache_read_tokens` and populates `#stat-input-tokens` with that total. Populates `#stat-cache-hit` with `total_cache_read_tokens`. Removed lines that set `#stat-cache-read` and `#stat-cache-write`.
- **Conversations table rendering** (line ~2143): `inputTokens` now computed as `total_input_tokens + total_cache_read_tokens`. `cacheDisplay` simplified to show only `cache_read_tokens` (no more `r/w` format).
- **`openConversation()`** (line ~2177): `totalInputTokens` now computed as `rawInput + totalCacheWrite + totalCacheRead`. Removed `conv-cache-write` assignment.
- **`openSettings()`** (line ~2453): Added `loadCacheMultipliers()` call alongside `loadCosts()`.
- **New functions** (line ~2608): `loadCacheMultipliers()` fetches `GET /api/settings/cache-multipliers`. `renderCacheTable()` renders a table with Anthropic/OpenAI rows and editable inputs. `updateCacheMultiplier()` POSTs changes to the API.

#### Settings Modal HTML
- **Line ~1362**: New "Cache Pricing (multiplier of input price)" section inserted between "Model Costs" and "Domain Colors". Contains `#cacheTable` with header columns Provider / Cache Hit / Cache Write, body `#cacheTableBody`, and help text explaining multiplier values.

### `src/dashboard/server.js`
- **Line ~519**: New `GET /api/settings/cache-multipliers` endpoint — calls `db.getCacheMultipliers()`.
- **Line ~530**: New `POST /api/settings/cache-multipliers` endpoint — accepts `{provider, read, write}` body, saves via `db.setSetting()` for the corresponding `cache_read_multiplier_{provider}` and `cache_write_multiplier_{provider}` keys.

### `src/api/server.js`
- **Line ~1349**: Added `cacheMultipliersCache` and `cacheMultipliersCacheTime` variables for DB read caching.
- **Line ~1372**: New `getCacheMultipliersFromDB()` function — same 60s TTL cache pattern as `getModelCostsFromDB()`. Returns result of `db.getCacheMultipliers()` or null on error.
- **`calculateCost()`** (line ~1418): Replaced hardcoded `cacheReadMultiplier`/`cacheWriteMultiplier` with values from `getCacheMultipliersFromDB()`. Falls back to previous hardcoded defaults (0.1/1.25 for Anthropic, 0.1/1.0 for OpenAI) if DB is unavailable.

## Key Design Decisions

1. **Cache creation (miss) folded into input**: Cache creation tokens are included in the "input" total because the user considers them normal input — they're billed at roughly base rate (1.25x on Anthropic, 1.0x on OpenAI). Showing them separately in the headline stat added confusion.

2. **Cache read (hit) shown as sub-value, not separate card**: The primary concern was the headline "Input Tokens" number matching Anthropic's dashboard. Showing cache hits as a sub-line provides the breakdown without cluttering the sidebar with a separate card.

3. **`getCacheStatistics()` left unchanged**: This method is specifically for per-provider cache ratio analysis where you need the raw `input_tokens` vs `cache_read_tokens` breakdown. Changing it would conflate the cached and uncached counts.

4. **Cache multiplier caching**: Uses the same 60s TTL pattern as `getModelCostsFromDB()` for consistency. The `getCacheMultipliersFromDB()` function structure mirrors `getModelCostsFromDB()` exactly.

5. **Existing DB infrastructure reused**: The `cache_read_multiplier_*` and `cache_write_multiplier_*` keys already existed in the schema defaults and `getCacheMultipliers()` already existed in `database.js`. The only gap was: no API endpoints to expose them, no UI to edit them, and `calculateCost()` wasn't reading them.
