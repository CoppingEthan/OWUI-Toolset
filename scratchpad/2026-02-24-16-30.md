# Title: Dashboard Domain-Based Chart Coloring, Cost Table Cleanup, Domain Dropdown Fix

## Issue Summary
Three dashboard improvements requested:
1. The domain dropdown needed to show `@example.com` format instead of bare `example.com`.
2. The model costs settings table showed both a friendly name (e.g. "Sonnet 4.5") and the pattern ID (e.g. `claude-sonnet-4-5`). The friendly name needed to be removed so only the pattern ID is displayed.
3. The Token Usage / Cost charts were colored per-model (purple for Claude, green for GPT, grey for Ollama). These needed to be replaced with per-domain coloring (e.g. `example.com` in orange, `test.co.uk` in pink), with user-configurable persistent color settings in the settings panel.

## Old Behaviour
- **Domain dropdown**: Showed `example.com (42)` as option text.
- **Cost table**: Each row displayed `<strong>Sonnet 4.5</strong>` with `<span>claude-sonnet-4-5</span>` beneath it, using the `MODEL_LABELS` lookup.
- **Charts**: Used a hardcoded `MODEL_COLORS` object mapping model IDs to RGBA colors (e.g. `claude-opus-4-5` → purple, `gpt-5.2` → green). Unknown models fell back to slate grey. The timeseries API returned data grouped by `model`. Chart datasets were created per-model with input/output splits.

## New Behaviour
- **Domain dropdown**: Shows `@example.com (42)` — prefixed with `@` for clarity.
- **Cost table**: Each row shows only `<strong>claude-sonnet-4-5</strong>` — the raw pattern, no friendly name mapping.
- **Charts**: Colored by email domain instead of model. The timeseries API now returns data grouped by `domain` (extracted from `user_email` via SQL `SUBSTR`/`INSTR`). A default palette of 10 colors auto-assigns to new domains and persists to the `settings` table. Users can change domain colors via color pickers in a new "Domain Colors" section in the settings modal. Chart titles changed from "Token Usage by Model" / "Cost by Model" to "Token Usage by Domain" / "Cost by Domain".

## Files Changed

### `src/database/database.js`
- **Lines 840–911**: Added `getTokenUsageTimeSeriesByDomainGroup(timeRange, domain)` method. Same date-format/time-filter switch logic as the existing `getTokenUsageTimeSeries`, but the SQL `SELECT` extracts domain from `user_email` using `CASE WHEN INSTR(user_email, '@') > 0 THEN SUBSTR(user_email, INSTR(user_email, '@') + 1) ELSE user_email END as domain`, and `GROUP BY time_bucket, domain`. Supports optional domain filter parameter. Includes `AND user_email != ''` guard.
- **Lines 913–926**: Added `getDomainColors()` method. Queries `settings` table for keys matching `domain_color_%`, strips the prefix, and returns `{domain: hexColor}` object.
- **Lines 928–936**: Added `setDomainColor(domain, color)` method. Delegates to `setSetting('domain_color_{domain}', color)`.
- **Existing methods preserved**: `getTokenUsageTimeSeries` (line 427) and `getTokenUsageTimeSeriesByDomain` (line 776) are untouched for backward compatibility.

### `src/dashboard/server.js`
- **Lines 174–186**: Modified `GET /api/stats/timeseries/:timeRange` endpoint. Previously called `db.getTokenUsageTimeSeriesByDomain()` or `db.getTokenUsageTimeSeries()` depending on domain param. Now always calls `db.getTokenUsageTimeSeriesByDomainGroup(timeRange, domain)` which handles both filtered and unfiltered cases. Response shape changed: `model` field replaced by `domain` field.
- **Lines 518–545**: Added two new endpoints:
  - `GET /api/settings/domain-colors` — calls `db.getDomainColors()`, returns `{domain: color}` map.
  - `POST /api/settings/domain-colors` — accepts `{domain, color}` JSON body, calls `db.setDomainColor()` then `db.save()`. Validates both fields are present.

### `src/dashboard/public/index.html`

#### CSS Changes
- **Lines ~932–970** (after `.save-costs-btn:hover`): Added new CSS classes: `.domain-color-list` (flex column container), `.domain-color-row` (flex row with gap, bottom border), `.domain-color-input` (36x28px color picker with custom webkit swatch styling), `.domain-color-name` (flex-1, 13px text).

#### HTML Changes
- **Line 1179**: Chart title changed from `Token Usage by Model` to `Token Usage by Domain`.
- **Lines 1363–1367**: Added new "Domain Colors" section in the settings modal between the "Model Costs" section and the "Danger Zone" section. Contains `<div id="domainColorsContainer" class="domain-color-list">` with a "No domains detected yet" placeholder.

#### JavaScript State Changes (lines ~1408–1460)
- **Removed**: `MODEL_COLORS` object (was lines 1366–1391) — the entire hardcoded model-to-color mapping.
- **Removed**: `getModelColors(model)` function (was lines 1394–1401).
- **Renamed**: `knownModels` → `knownDomains` (array of domain strings from API data).
- **Added**: `domainColors = {}` — runtime map of `{domain: '#hexcolor'}`, loaded from settings API.
- **Added**: `domainColorsLoaded = false` — flag to load colors only once.
- **Added**: `DEFAULT_DOMAIN_PALETTE` — array of 10 hex colors: orange `#f97316`, pink `#ec4899`, blue `#3b82f6`, green `#10b981`, purple `#8b5cf6`, amber `#f59e0b`, cyan `#06b6d4`, red `#ef4444`, lime `#84cc16`, indigo `#6366f1`.
- **Added**: `hexToRgba(hex, alpha)` — converts `#rrggbb` to `rgba(r, g, b, alpha)` string for Chart.js.
- **Added**: `getDomainChartColors(domain)` — returns `{output: {bg, border}, input: {bg, border}}` using the domain's hex color at 0.9/1.0 (output) and 0.4/0.6 (input) opacity.
- **Preserved**: `MODEL_LABELS` object — still used in the conversation modal timeline (line ~2167) for model badge display.

#### Chart Toggle (line ~1631)
- Changed title text from `'Token Usage by Model'` / `'Cost by Model'` to `'Token Usage by Domain'` / `'Cost by Domain'`.

#### Domain Dropdown (line ~1671)
- Changed `option.textContent` from `` `${d.domain} (${d.count})` `` to `` `@${d.domain} (${d.count})` ``.

#### Data Loading (lines ~1761–1790)
- **Added** `loadDomainColors()` async function — fetches `GET /api/settings/domain-colors` and stores result in `domainColors`.
- **Modified** `loadData()` — before the `Promise.all` batch, checks `domainColorsLoaded` flag and calls `await loadDomainColors()` on first load. This ensures colors are available before chart rendering.

#### Time Series Loading (lines ~1840–1880)
- Changed field access from `d.model` to `d.domain` when building `knownDomains` and `dataMap`.
- Added auto-assign logic: iterates `knownDomains`, checks if each domain has a color in `domainColors`. If not, picks the first unused color from `DEFAULT_DOMAIN_PALETTE` (cycling if exhausted), assigns it, and fire-and-forgets a `POST /api/settings/domain-colors` to persist.

#### Chart Rendering (lines ~1900–1955)
- Replaced `knownModels.forEach(model => ...)` with `knownDomains.forEach(domain => ...)`.
- Replaced `getModelColors(model)` with `getDomainChartColors(domain)`.
- Replaced `MODEL_LABELS[model] || model` with just `domain` for dataset labels.
- Stack identifiers changed from model ID to domain string.
- All tooltip callbacks unchanged (they use `dataset.label.includes('Input')` / `includes('Output')` which still works with domain-based labels like `"example.com Output"`).

#### Cost Table (line ~2346)
- Removed `MODEL_LABELS` lookup: was `const displayName = MODEL_LABELS[pattern] || pattern` → now just uses `pattern` directly.
- Simplified `<td>` from `<strong>displayName</strong><br><span>pattern</span>` to `<strong>pattern</strong>`.

#### Settings Modal (lines ~2400–2440)
- `openSettings()` now also calls `renderDomainColors()` after `loadCosts()`.
- **Added** `renderDomainColors()` — reads `domainColors`, sorts keys alphabetically, renders a `<div class="domain-color-row">` per domain with a `<input type="color">` and `@domain` label. Shows "No domains detected yet" if empty.
- **Added** `updateDomainColor(domain, color)` — updates `domainColors[domain]`, POSTs to `/api/settings/domain-colors`, then re-renders the chart via `renderChart(cachedTimeSeriesData)` for immediate visual feedback.

## Key Design Decisions

1. **New DB method instead of modifying existing**: Added `getTokenUsageTimeSeriesByDomainGroup` rather than modifying `getTokenUsageTimeSeries` or `getTokenUsageTimeSeriesByDomain`. The old methods are preserved untouched in case any other code depends on the `model`-grouped response shape (e.g. future API consumers).

2. **Domain colors stored in `settings` table**: Reuses the existing key-value settings infrastructure with `domain_color_{domain}` keys rather than adding a new table. This is consistent with how model costs are stored (`cost_{pattern}_{input|output}`).

3. **Auto-assign with fire-and-forget persistence**: When a new domain appears in chart data without a saved color, a color is assigned from the palette immediately (so the chart renders without delay) and a POST is sent to save it (without awaiting). This means colors are persistent from their first appearance with no user action required.

4. **Colors loaded once per session**: `domainColorsLoaded` flag prevents re-fetching colors on every 15-second refresh cycle. Colors are only refreshed when explicitly changed via the settings modal.

5. **MODEL_LABELS kept for conversation modal**: The friendly model names ("Sonnet 4.5", "GPT-5.2") are still useful in the conversation detail timeline where each assistant response shows a model badge. Removing them entirely would degrade that UI.

6. **Palette cycling**: If more than 10 domains exist, colors cycle through the palette. The `Set` of used colors ensures no duplicates until the palette is exhausted, then falls back to index-based cycling.
